<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loushuiyifan.report.dao.RptQueryIncomeNumDAO">

	<select id="listdataForMap" resultType="com.loushuiyifan.report.vo.RptIncomeNumVO">
	
	select a.month,
       sum(decode(a.succ_code, 1, 1, 0)) as success,
       sum(decode(a.succ_code, 0, 1, 0)) as fail
       from (
        <if test='type =="0"'>
          select to_char(trunc(REQUEST_TIME), 'yyyy-mm') as month,
               decode(sum(nvl(t.RESULTCODE, 1)), 0, 1, 0) as succ_code
          from (select session_id,
                       SERVICE_TYPE,
                       RESULTCODE,
                       REQUEST_TIME,
                       row_number() over(partition by session_id, SERVICE_TYPE order by SERVICE_TYPE, REQUEST_TIME desc) rn1
                  from Rpt_Msg_Result
                 where session_id like 'EDA%07'
                 and to_char(trunc(REQUEST_TIME), 'yyyy') = #{month} 
                   ) t
         where t.rn1 = 1
         group by t.session_id, to_char(trunc(REQUEST_TIME), 'yyyy-mm')     
        </if>
  		<if test='type =="1"'>
          select to_char(trunc(REQUEST_TIME), 'yyyy-mm-dd') as month,
               decode(sum(nvl(t.RESULTCODE, 1)), 0, 1, 0) as succ_code
          from (select session_id,
                       SERVICE_TYPE,
                       RESULTCODE,
                       REQUEST_TIME,
                       row_number() over(partition by session_id, SERVICE_TYPE order by SERVICE_TYPE, REQUEST_TIME desc) rn1
                  from Rpt_Msg_Result
                 where session_id like 'EDA%07'
                 and to_char(trunc(REQUEST_TIME), 'yyyymm') = #{month} 
                   ) t
         where t.rn1 = 1
         group by t.session_id, to_char(trunc(REQUEST_TIME), 'yyyy-mm-dd')     
        </if>
          
         ) a
          group by a.month
	
	</select>


</mapper>
