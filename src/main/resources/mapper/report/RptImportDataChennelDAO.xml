<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loushuiyifan.report.dao.RptImportDataChennelDAO">

    <select id="checkRptImportData" parameterType="com.loushuiyifan.report.dto.SPDataDTO"
            statementType="CALLABLE">
        {call rpt_data_check(
         #{logId,mode=IN,jdbcType=NUMERIC},
         #{rtnCode,mode=OUT,jdbcType=NUMERIC},
         #{rtnMsg,mode=OUT,jdbcType=VARCHAR})}
    </select>

    <delete id="deleteByLogId">
        delete
        from rpt_import_data_channel
        where log_id =#{logId}
    </delete>

    <select id="listIncomeDataLog" resultType="com.loushuiyifan.report.vo.ImportDataLogVO">
        select b.log_id as "logId",
        b.file_name as "fileName",
        count(*) as "num",
        sum(a.index_data) as "sum",
        c.name as "city",
        b.user_id as "userId",
        d.nickname as "userName",
        nvl(sum(case when e.index_id <![CDATA[<=]]> ('17011234') then  a.index_data    end ),0) as "sum2",
        b.STATUS as "action",
        b.export_desc as "remark",
        b.IS_ITSM as "isItsm",
        b.ITSM_STATUS as "itsmStatus",
        b.ITSM_ORDER_NO as "itsmOrderNo",
        b.ITSM_URL as "itsmUrl",
        b.eip as "eip"
        from Rpt_Import_Data_Channel a,
        EXT_IMPORT_LOG b,
         rpt_repfield_def_channel e,
        (select n.*
        from AWEB_ORGANIZATION m, AWEB_ORGANIZATION n
        where m.type = 'local_net'
        and n.type = 'local_net'
        and m.data = #{latnId}
        and ((n.parent_ids like m.parent_ids || m.id || '/%' and
        n.lvl <![CDATA[ < ]]> 4) or n.data = #{latnId})) c,
        aweb_user d
        where a.acct_month =  #{month}
        and a.log_id = b.log_id
        and c.data = b.latn_id
        and b.type = #{type}
        and b.user_id = d.id
        and e.rpt_no=1701
        and e.group_id=0
        and a.ver_code=e.index_code
        group by b.STATUS, b.log_id, b.file_name, c.name, b.user_id,d.nickname ,
         b.export_desc,b.IS_ITSM,b.ITSM_STATUS, b.ITSM_ORDER_NO,b.ITSM_URL,b.eip
        order by b.STATUS desc
    </select>


    <select id="selectAction" resultType="string">
        select distinct t.action
        from Rpt_Import_Data_Channel t
		where t.log_id = #{logId}
    </select>


    <select id="iseeC4Cut" parameterType="com.loushuiyifan.report.dto.SPDataDTO"
            statementType="CALLABLE">
        {call PKG_SHELLY_DEV.isee_cut(
        #{month,mode=IN,jdbcType=VARCHAR},
        #{logId,mode=IN,jdbcType=NUMERIC},
        #{rtnCode,mode=OUT,jdbcType=NUMERIC},
        #{rtnMsg,mode=OUT,jdbcType=VARCHAR})}
    </select>

    <select id="commitRptImportData" parameterType="com.loushuiyifan.report.dto.SPDataDTO"
            statementType="CALLABLE">
        {call irpt_IndexToParentChannel(
        #{logId,mode=IN,jdbcType=NUMERIC},
        #{rtnCode,mode=OUT,jdbcType=NUMERIC},
        #{rtnMsg,mode=OUT,jdbcType=VARCHAR})}
    </select>

    <select id="deleteImportData" parameterType="com.loushuiyifan.report.dto.SPDataDTO"
            statementType="CALLABLE">
        {call IRPT_DEL_DATA_CN(
        #{userId,mode=IN,jdbcType=NUMERIC},
        #{logId,mode=IN,jdbcType=NUMERIC},
        #{rtnCode,mode=OUT,jdbcType=NUMERIC},
        #{rtnMsg,mode=OUT,jdbcType=VARCHAR})}
    </select>

</mapper>


